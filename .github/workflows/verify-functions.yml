name: Verify Function Integrity

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**/*.c'
      - 'extracted/**/*.c'
  push:
    branches: [ main ]
    paths:
      - 'src/**/*.c'
      - 'extracted/**/*.c'
  workflow_dispatch:
    inputs:
      init_baseline:
        description: 'Initialize baseline hashes'
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.PAT_TOKEN || github.token }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Initialize baseline (if requested)
      if: github.event.inputs.init_baseline == 'true'
      run: |
        python tools/verify_functions.py \
          --src src \
          --extracted extracted \
          --baseline .github/data/function_hashes.json \
          --init-baseline

        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add .github/data/function_hashes.json
        git diff --staged --quiet || git commit -m "Initialize function baseline hashes [skip ci]"
        git push

    - name: Verify functions
      if: github.event.inputs.init_baseline != 'true'
      id: verify
      run: |
        python tools/verify_functions.py \
          --src src \
          --extracted extracted \
          --baseline .github/data/function_hashes.json \
          --output verification_report.md

        # Count errors
        if grep -q "Errors: 0" verification_report.md 2>/dev/null || ! grep -q "### Errors" verification_report.md; then
          echo "has_errors=false" >> $GITHUB_OUTPUT
        else
          echo "has_errors=true" >> $GITHUB_OUTPUT
        fi

    - name: Generate summary
      if: github.event.inputs.init_baseline != 'true'
      run: |
        echo "## Function Verification Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        cat verification_report.md >> $GITHUB_STEP_SUMMARY

    - name: Comment on PR
      if: github.event_name == 'pull_request' && github.event.inputs.init_baseline != 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('verification_report.md', 'utf8');
          const hasErrors = '${{ steps.verify.outputs.has_errors }}' === 'true';

          // Check for existing comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number
          });

          const botComment = comments.find(c =>
            c.user.type === 'Bot' && c.body.includes('## Function Verification')
          );

          const icon = hasErrors ? '❌' : '✅';
          const body = `## Function Verification ${icon}\n\n${report}\n\n---\n*Checks that refactored functions properly reference originals and extracted code is unmodified*`;

          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
          }

    - name: Upload report
      if: github.event.inputs.init_baseline != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: verification-report
        path: verification_report.md

    - name: Fail on errors (PRs only)
      if: github.event_name == 'pull_request' && steps.verify.outputs.has_errors == 'true'
      run: |
        echo "::error::Function verification failed - see report for details"
        exit 1
